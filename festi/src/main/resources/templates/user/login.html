<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카카오 로그인 테스트</title>
</head>
<body>

<h1>카카오 로그인 테스트</h1>

<button onclick="loginWithKakao()">카카오 로그인</button>
<button onclick="getProfile()">프로필 조회</button>
<input type="text" id="newNickname" placeholder="새 닉네임 입력">
<button onclick="changeNickname()">닉네임 변경</button>
<button onclick="logout()">로그아웃</button>

<h2>결과</h2>
<pre id="result"></pre>

<script>
    const backendUrl = "http://localhost:8080"; // 백엔드 API 주소

    // 1. 카카오 로그인 (로그인 버튼 클릭)
    function loginWithKakao() {
        const kakaoAuthUrl = `https://kauth.kakao.com/oauth/authorize?client_id=0e9c4f7b52ccaf36a3f6e27337b6b10d&redirect_uri=http://localhost:8080/user/login&response_type=code`;
        window.location.href = kakaoAuthUrl; // 카카오 로그인 페이지로 이동
    }

    // 2. 로그인 후 JWT 저장
    async function handleLoginCallback() {
        const params = new URLSearchParams(window.location.search);
        if (params.has('code')) {
            const code = params.get('code');
            const response = await fetch(`${backendUrl}/api/auth/login?code=${code}`, {
                method: "POST",
            });
            const token = await response.text();
            localStorage.setItem("jwtToken", token);
            document.getElementById("result").innerText = "로그인 성공! JWT 저장됨";
        }
    }

    // 3. 프로필 조회 (JWT 포함)
    async function getProfile() {
        const token = localStorage.getItem("jwtToken");
        if (!token) {
            alert("로그인이 필요합니다.");
            return;
        }
        const response = await fetch(`${backendUrl}/api/auth/profile`, {
            method: "GET",
            headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await response.json();
        document.getElementById("result").innerText = JSON.stringify(data, null, 2);
    }

    // 4. 닉네임 변경
    async function changeNickname() {
        console.log("닉네임 변경 함수 실행됨");

        const token = localStorage.getItem("jwtToken");
        if (!token) {
            alert("로그인이 필요합니다.");
            console.log("JWT 없음");
            return;
        }

        const kakaoId = getKakaoIdFromToken(); // JWT에서 kakaoId 추출
        if (!kakaoId) {
            alert("사용자 정보를 가져올 수 없습니다.");
            console.log("kakaoId 없음");
            return;
        }

        const newNickname = document.getElementById("newNickname").value;
        console.log("보낼 데이터:", { kakaoId, newNickname });

        try {
            const response = await fetch(`${backendUrl}/api/user/nickname`, {
                method: "PATCH",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ kakaoId, newNickname })
            });

            console.log("응답 상태 코드:", response.status);
            const result = await response.text();
            console.log("서버 응답:", result);

            if (response.ok) {
                document.getElementById("result").innerText = "닉네임 변경 완료!";
            } else {
                document.getElementById("result").innerText = "닉네임 변경 실패!";
            }
        } catch (error) {
            console.error("닉네임 변경 요청 중 오류 발생:", error);
        }
    }



    function logout() {
    const token = localStorage.getItem("jwtToken");

        if (!token) {
            alert("이미 로그아웃되었습니다.");
            return;
        }

        // ✅ 백엔드에서 서비스 로그아웃 실행
        fetch(`${backendUrl}/api/auth/logout`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${token}` }
        }).then(response => {
            if (response.ok) {
                localStorage.removeItem("jwtToken"); // ✅ JWT 삭제
                document.getElementById("result").innerText = "로그아웃 완료!";

                // ✅ 카카오 계정까지 로그아웃 (로그인 화면으로 이동)
                window.location.href = `https://kauth.kakao.com/oauth/logout?client_id=0e9c4f7b52ccaf36a3f6e27337b6b10d&logout_redirect_uri=http://localhost:8080/user/login`;
            } else {
                document.getElementById("result").innerText = "로그아웃 실패!";
            }
        }).catch(error => console.error("로그아웃 요청 중 오류 발생:", error));
    }

    // JWT를 디코딩하는 함수
    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1]; // JWT의 payload 부분
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(
                atob(base64)
                    .split('')
                    .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
                    .join('')
            );
            return JSON.parse(jsonPayload);
        } catch (e) {
            console.error("JWT 파싱 오류:", e);
            return null;
        }
    }

    // JWT에서 kakaoId 추출
    function getKakaoIdFromToken() {
        const token = localStorage.getItem("jwtToken");
        if (!token) {
            console.log("JWT 없음");
            return null;
        }

        const decodedToken = parseJwt(token);
        console.log("디코딩된 JWT:", decodedToken);

        return decodedToken ? decodedToken.sub : null; // 'sub' 필드에 kakaoId 저장됨
    }


    // 로그인 후 자동으로 콜백 처리
    window.onload = handleLoginCallback;
</script>

</body>
</html>
