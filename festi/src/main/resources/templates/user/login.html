<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카카오 로그인 테스트</title>
</head>
<body>

<h1>카카오 로그인 테스트</h1>

<button onclick="loginWithKakao()">카카오 로그인</button>
<button onclick="getProfile()">프로필 조회</button>
<input type="text" id="newNickname" placeholder="새 닉네임 입력">
<button onclick="changeNickname()">닉네임 변경</button>
<button onclick="logout()">로그아웃</button>

<h2>결과</h2>
<pre id="result"></pre>

<script>
    const backendUrl = "http://localhost:8080"; // 백엔드 API 주소

    // 1. 카카오 로그인 (로그인 버튼 클릭)
    function loginWithKakao() {
        const kakaoAuthUrl = `https://kauth.kakao.com/oauth/authorize?client_id=0e9c4f7b52ccaf36a3f6e27337b6b10d&redirect_uri=http://localhost:8080/user/login&response_type=code`;
        window.location.href = kakaoAuthUrl; // 카카오 로그인 페이지로 이동
    }

    async function handleLoginCallback() {
        const params = new URLSearchParams(window.location.search);

        if (params.has('code')) {
            const code = params.get('code');

            try {
                const response = await fetch(`${backendUrl}/api/auth/login`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ code })
                });

                console.log("서버 응답 상태 코드:", response.status);

                // ❗ 응답이 정상(200 OK)인지 확인
                if (!response.ok) {
                    throw new Error(`서버 응답 오류: ${response.status}`);
                }

                // ✅ JSON 변환 처리
                const data = await response.json();
                console.log("서버 응답 데이터:", data);

                // ✅ JWT 저장 및 UI 업데이트
                localStorage.setItem("jwtToken", data.jwtToken);
                document.getElementById("result").innerText = `로그인 성공! 신규 유저 여부: ${data.isNewUser}`;

            } catch (error) {
                console.error("로그인 요청 중 오류 발생:", error);
                document.getElementById("result").innerText = `로그인 실패: ${error.message}`;
            }
        }
    }

    // 3. 프로필 조회 (JWT 포함)
    async function getProfile() {
        const token = localStorage.getItem("jwtToken");
        if (!token) {
            alert("로그인이 필요합니다.");
            return;
        }
        const response = await fetch(`${backendUrl}/api/auth/profile`, {
            method: "GET",
            headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await response.json();
        document.getElementById("result").innerText = JSON.stringify(data, null, 2);
    }

    async function changeNickname() {
        console.log("닉네임 변경 함수 실행됨");

        const token = localStorage.getItem("jwtToken");
        if (!token) {
            alert("로그인이 필요합니다.");
            return;
        }

        const newNickname = document.getElementById("newNickname").value;

        try {
            const response = await fetch(`${backendUrl}/api/user/nickname`, {
                method: "PATCH",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ newNickname }) // ✅ 수정된 요청
            });

            const result = await response.json();
            document.getElementById("result").innerText = result.message;
        } catch (error) {
            console.error("닉네임 변경 요청 중 오류 발생:", error);
        }
    }


    function logout() {
        const token = localStorage.getItem("jwtToken");

        if (!token) {
            alert("이미 로그아웃되었습니다.");
            return;
        }

        fetch(`${backendUrl}/api/auth/logout`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${token}` }
        }).then(response => response.json())
          .then(result => {
              localStorage.removeItem("jwtToken");
              document.getElementById("result").innerText = result.message;

              // ✅ 카카오 로그아웃 처리
              window.location.href = `https://kauth.kakao.com/oauth/logout?client_id=0e9c4f7b52ccaf36a3f6e27337b6b10d&logout_redirect_uri=http://localhost:8080/user/login`;
          })
          .catch(error => console.error("로그아웃 요청 중 오류 발생:", error));
    }

    // JWT를 디코딩하는 함수
    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1]; // JWT의 payload 부분
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(
                atob(base64)
                    .split('')
                    .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
                    .join('')
            );
            return JSON.parse(jsonPayload);
        } catch (e) {
            console.error("JWT 파싱 오류:", e);
            return null;
        }
    }

    // JWT에서 kakaoId 추출
    function getKakaoIdFromToken() {
        const token = localStorage.getItem("jwtToken");
        if (!token) {
            console.log("JWT 없음");
            return null;
        }

        const decodedToken = parseJwt(token);
        console.log("디코딩된 JWT:", decodedToken);

        return decodedToken ? decodedToken.sub : null; // 'sub' 필드에 kakaoId 저장됨
    }


    // 로그인 후 자동으로 콜백 처리
    window.onload = handleLoginCallback;
</script>

</body>
</html>
